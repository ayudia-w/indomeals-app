<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indomeals - Meal Planner</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to our external CSS file -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="p-6 flex items-center justify-center min-h-screen">
    <div class="container card p-8 space-y-8">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">üçΩÔ∏è Indomeals - Meal Planner</h1>

        <!-- Input Form -->
        <form id="mealPlanForm" class="space-y-6">
            <div>
                <label for="days" class="block text-lg font-medium text-gray-700 mb-2">Buat meal plan untuk berapa hari?</label>
                <select id="days" name="days" class="input-field">
                    <option value="3">3 Hari</option>
                    <option value="7">7 Hari</option>
                </select>
            </div>

            <div>
                <label for="portions" class="block text-lg font-medium text-gray-700 mb-2">Porsi sekali masak:</label>
                <input type="number" id="portions" name="portions" min="1" value="1" class="input-field">
            </div>

            <div>
                <label class="block text-lg font-medium text-gray-700 mb-2">Alergi:</label>
                <div class="flex flex-wrap gap-4">
                    <label class="checkbox-label">
                        <input type="checkbox" name="allergens" value="telur" class="checkbox-input">
                        <span>Telur</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="allergens" value="kacang" class="checkbox-input">
                        <span>Kacang</span>
                    </label>
                    <!-- Add more allergens as needed -->
                </div>
            </div>

            <button type="submit" class="btn-primary w-full">Buat Meal Plan & Shopping List</button>
        </form>

        <!-- Message Box for Feedback -->
        <div id="messageBox" class="message-box hidden"></div>

        <!-- Results Section -->
        <div id="results" class="space-y-8 hidden">
            <!-- Meal Plan Section -->
            <div>
                <h2 class="text-3xl font-semibold text-gray-800 mb-4 text-center">Your Meal Plan</h2>
                <div id="mealPlanOutput" class="space-y-6">
                    <!-- Meal plan will be rendered here -->
                </div>
            </div>

            <!-- Shopping List Section -->
            <div>
                <h2 class="text-3xl font-semibold text-gray-800 mb-4 text-center">Your Shopping List</h2>
                <ul id="shoppingListOutput" class="list-disc list-inside text-gray-700 space-y-2">
                    <!-- Shopping list will be rendered here -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('mealPlanForm');
            const messageBox = document.getElementById('messageBox');
            const resultsSection = document.getElementById('results');
            const mealPlanOutput = document.getElementById('mealPlanOutput');
            const shoppingListOutput = document.getElementById('shoppingListOutput');

            // Function to display messages (errors or success)
            function showMessage(message, type) {
                messageBox.textContent = message;
                messageBox.className = `message-box ${type}`;
                messageBox.classList.remove('hidden');
            }

            // Function to clear messages
            function clearMessage() {
                messageBox.classList.add('hidden');
                messageBox.textContent = '';
            }

            form.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission

                clearMessage(); // Clear previous messages
                resultsSection.classList.add('hidden'); // Hide previous results

                const days = document.getElementById('days').value;
                const portions = document.getElementById('portions').value;
                const selectedAllergens = Array.from(document.querySelectorAll('input[name="allergens"]:checked'))
                                                .map(cb => cb.value);

                try {
                    const response = await fetch('http://127.0.0.1:5000/plan_meals', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            days: parseInt(days),
                            portions: parseInt(portions),
                            allergens: selectedAllergens
                        }),
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        showMessage(data.error || 'An error occurred while planning meals.', 'error');
                        return;
                    }

                    // Display Meal Plan
                    mealPlanOutput.innerHTML = ''; // Clear previous content
                    data.meal_plan.forEach(dayPlan => {
                        const dayDiv = document.createElement('div');
                        dayDiv.className = 'card p-4 space-y-2';

                        // Join the array of meal names for display (no breakfast now)
                        const lunchMeals = dayPlan.lunch.join(', ');
                        const dinnerMeals = dayPlan.dinner.join(', ');

                        dayDiv.innerHTML = `
                            <h3 class="text-xl font-semibold text-gray-700">Day ${dayPlan.day}</h3>
                            <p><strong>Lunch:</strong> ${lunchMeals}</p>
                            <p><strong>Dinner:</strong> ${dinnerMeals}</p>
                        `;
                        mealPlanOutput.appendChild(dayDiv);
                    });

                    // Display Shopping List
                    shoppingListOutput.innerHTML = ''; // Clear previous content
                    if (Object.keys(data.shopping_list).length > 0) {
                        for (const [item, quantity] of Object.entries(data.shopping_list)) {
                            const listItem = document.createElement('li');
                            listItem.textContent = `${item}: ${quantity}`;
                            shoppingListOutput.appendChild(listItem);
                        }
                    } else {
                        const listItem = document.createElement('li');
                        listItem.textContent = 'No ingredients needed for the selected meals.';
                        shoppingListOutput.appendChild(listItem);
                    }

                    resultsSection.classList.remove('hidden');
                    showMessage('Meal plan and shopping list generated successfully!', 'success');

                } catch (error) {
                    console.error('Error:', error);
                    showMessage('Failed to connect to the server. Please ensure the Flask backend is running.', 'error');
                }
            });
        });
    </script>
</body>
</html>
